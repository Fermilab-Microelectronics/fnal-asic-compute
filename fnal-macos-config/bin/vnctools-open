#!/usr/bin/env bash

source `which vnctools-opts` $@
display=${display:?"Error. display not define"}
hostname=${hostname:?"Error. hostname not define"}
username=${username:?"Error. username not define"}

clean_up () {
    for job in `jobs -p`; do
        kill ${job}
    done
}

(
    set -x
    trap "clean_up; exit 1" INT

    kinit -ft ~/.kerberos/${username}.keytab ${username}@FNAL.GOV && klist
    ssh -4CKNq -L 59${display}:localhost:59${display} ${username}@${hostname}.fnal.gov &

    sleep 1
    # open -W vnc://localhost:59${display}
    /Applications/VNC\ Viewer.app/Contents/MacOS/vncviewer localhost:5949
    clean_up
    wait
)