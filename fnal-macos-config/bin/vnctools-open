#!/usr/bin/env bash

(
    source `which vnctools-opts` $@
    display=${display:?"Error. display not define"}
    hostname=${hostname:?"Error. hostname not define"}
    username=${username:?"Error. username not define"}

    clean_up () {
        for job in `jobs -p`; do
            kill ${job}
        done
    }

    set -x
    trap "clean_up; exit 1" INT

    kinit -ft ~/.kerberos/${username}.keytab ${username}@FNAL.GOV && klist
    ssh  -4CKq -L 5900:localhost:5900  ${username}@${hostname}.fnal.gov \
        "x11vnc -display :${display} -localhost -usepw -once -noxdamage -snapfb -speeds dsl -shared" &

    sleep 4
    case true in
        ${flag_realvnc:=})
            /Applications/VNC\ Viewer.app/Contents/MacOS/vncviewer localhost:5900
            ;;
        ${screenshare:=})
            open -W vnc://localhost:5900
            ;;
        *)
            open -W vnc://localhost:5900
            ;;
    esac

    clean_up
    wait
)
