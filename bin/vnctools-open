#!/usr/bin/env bash

# parse the command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --username=*)
            username="${1#*=}"
            shift
            ;;
        --hostname=*)
            hostname="${1#*=}"
            shift
            ;;
        --display=*)
            display="${1#*=}"
            shift
            ;;
        *)
            echo "Unknown option $1"
            shift
            ;;
    esac
done

username=${username:?"Error. username not define"}
hostname=${hostname:?"Error. hostname not define"}
display=${display:?"Error. display not define"}


clean_up () {
    for job in `jobs -p`; do
        kill ${job}
    done
}


(
    set -x
    trap "clean_up; exit 1" INT

    kinit -ft ~/.kerberos/${username}.keytab ${username}@FNAL.GOV && klist
    ssh -C -N -q -K -L 59${display}:localhost:59${display} ${username}@${hostname}.fnal.gov &
    
    sleep 1
    open -W vnc://localhost:59${display}
    clean_up
    wait
) 